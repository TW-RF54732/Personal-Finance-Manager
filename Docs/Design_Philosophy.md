# 財務系統設計哲學（Design Philosophy）

## 設計目標

本系統的核心目標是：

> 以**模組化、可擴充、資料嚴謹、UX 友善**為前提，建立能支撐長期維運與複雜業務邏輯的財務記錄系統。

系統需同時兼顧：

1. **資料一致性**（數據結構穩定、方向一致）
2. **操作靈活性**（可人工調整、兼容例外狀況）
3. **功能可組合性**（業務邏輯可由多個基本操作構成）
4. **層級清晰**（資料層與應用層分工明確）
5. **UX導向**（使用者能以最小操作完成任務）

---

## 設計哲學總覽

### 一、模組化層級

整體架構遵循分層設計原則，分為三個層級：


| 層級                      | 職責                                              | 範例                                        |
| ------------------------- | ------------------------------------------------- | ------------------------------------------- |
| **Core（資料層）**        | 與資料庫直接交互，提供基本 CRUD 與查詢功能        | `add_log()`, `get_category()`               |
| **Service（業務邏輯層）** | 封裝可重複使用的邏輯，如分類查詢、篩選、合計等    | `filter_by_category()`, `sum_expenditure()` |
| **Application（應用層）** | 控制應用行為，組合多項 service 功能以完成複雜任務 | 刪除指定條件的所有項目、生成報表、UI交互    |

這種設計的重點是：

* **Core 不懂邏輯，只懂資料**
* **Service 不懂使用者，只懂規則**
* **Application 不懂資料庫，只懂任務**

---

### 二、資料一致性與方向性

為兼顧 UX 與會計邏輯，系統採用「**雙向設計（Direction Duplication）**」：

* 類別（Category）內儲存「預設方向」（收入/支出）
* 日誌（FinanceLog）內儲存「實際方向」

**原因：**

* 讓 UX 層只需讓使用者「選類別」，方向自動帶入。
* 當有特例（如賒帳、退費）時，可手動在該筆日誌調整方向，不影響類別預設值。
* 若整體類別方向改變（例如「紅包」從收入轉為輸出），修改類別即可更新後續新增項目。

**優點：**

* 維持資料嚴謹：日誌與類別能獨立描述狀態。
* 保持靈活性：允許例外狀況存在。
* 可追溯性：歷史紀錄保留當時的真實方向。

---

### 三、處理與運算層級


| 類別                                 | 應該在哪一層處理 | 原因                                     |
| ------------------------------------ | ---------------- | ---------------------------------------- |
| **排序與過濾**                       | `Service`        | SQL 層效率高，屬於查詢邏輯               |
| **統計（合計、餘額）**               | `Application`    | 通常是多次查詢組合結果，例如過濾後再統計 |
| **複合操作（例如刪除特定篩選結果）** | `Application`    | 涉及流程控制與多步行為                   |
| **資料一致性檢查**                   | `Service`        | 與業務邏輯緊密相關，如支出不能為負       |
| **資料校正或批次修改**               | `Application`    | 通常屬於使用者發起的高層操作             |

---

### 四、資料修改哲學(尚未實裝)

資料更新採用「**覆寫優先，刪除次之**」原則：

1. 若能更新，**更新資料而非刪除重建**，以保留歷史 ID 與時間戳。
2. 若結構性改變（如類別被合併或重分），再進行「刪除 + 新增」。
3. 更新需記錄操作時間與操作者，以支援審計。

---

### 五、彈性與未來擴充

設計預期未來將支援以下功能：

* **報表快取與統計預運算**
* **應收應付／預付預收**
* **多貨幣、匯率轉換**
* **分錄記帳（Journal Entry）**

因此：

* 每個模組應**獨立、低耦合、可測試**。
* Service 方法應**以最小單位責任**設計，例如 `delete_by_id()` 而非 `delete_by_day_and_category()`。
* Application 可**自由組合**多個 service 功能實現複雜業務。

---

### 六、UX 與人性化考量

* 使用者應該**只需思考行為，不需理解資料結構**。
  例如選擇「餐飲費」即可自動推入支出方向。
* 支援**例外覆寫**：使用者可手動改方向或金額。
* 支援**一致化選項**：防止同義類別重複（如「伙食費」vs「餐飲」）。
* 適當提供**引導與錯誤修正建議**（如自動分類或比對異常支出）。

---

## 核心理念摘要

> 系統的設計重點不在於「快速實現功能」，
> 而在於「確保每一層邏輯都能被單獨理解、替換與擴充」。

用一句話總結：

> **資料層保證真實、業務層保證邏輯、應用層保證價值。**
>
